<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select Your Name</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e0f7fa;
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #00796b;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }
    tr:hover {
      background-color: #b2dfdb;
    }
    .submit-btn {
      margin-top: 20px;
      display: block;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #00796b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .submit-btn:hover {
      background-color: #004d40;
    }
    .note {
      color: red;
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
    }
    .distance-info {
      margin-top: 10px;
      text-align: center;
      font-weight: bold;
      color: #004d40;
    }
  </style>
</head>
<body>
  <h2>Select Your Name and Roll Number</h2>
  <div class="note" id="note">Fetching your location... Please allow location access.</div>

  <form id="attendanceForm" method="POST" action="/mark">
    <input type="hidden" name="session_id" value="{{ session_id }}">
    <input type="hidden" id="latitude" name="latitude" />
    <input type="hidden" id="longitude" name="longitude" />
    
    <table>
      <tr>
        <th>Select</th>
        <th>{{ roll_col }}</th>
        <th>{{ name_col }}</th>
      </tr>
      {% for student in students %}
      <tr>
        <td>
          <input type="radio" name="roll_number" value="{{ student[roll_col] }}" required
                 data-name="{{ student[name_col] }}" />
        </td>
        <td>{{ student[roll_col] }}</td>
        <td>{{ student[name_col] }}</td>
      </tr>
      {% endfor %}
    </table>
    
    <input type="hidden" name="name" id="student_name" />
    <button type="submit" class="submit-btn" id="submitBtn" disabled>Submit Attendance</button>
  </form>

  <div class="distance-info" id="distanceInfo"></div>

  <script>
    const allowedLat = {{ allowed_lat }};
    const allowedLon = {{ allowed_lon }};
    const allowedRadius = {{ allowed_radius }};

    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371000; // meters

      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);

      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c;
    }

    window.onload = function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lon;
            document.getElementById("note").style.display = "none";

            const dist = haversine(lat, lon, allowedLat, allowedLon);
            const distElem = document.getElementById("distanceInfo");

            if (dist <= allowedRadius) {
              distElem.style.color = "green";
              distElem.textContent = `You are within the allowed radius (${dist.toFixed(1)} meters). You can submit attendance.`;
              document.getElementById("submitBtn").disabled = false;
            } else {
              distElem.style.color = "red";
              distElem.textContent = `You are outside the allowed radius (${dist.toFixed(1)} meters). Attendance cannot be marked.`;
              document.getElementById("submitBtn").disabled = true;
            }
          },
          function (error) {
            document.getElementById("note").innerText = "Location access denied or unavailable. Attendance cannot be marked.";
            alert("Error: " + error.message + "\nPlease refresh and allow location access.");
            document.getElementById("submitBtn").disabled = true;
          },
          { enableHighAccuracy: true }
        );
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    };

    document.querySelectorAll('input[name="roll_number"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const selectedName = this.getAttribute('data-name');
        document.getElementById('student_name').value = selectedName;
      });
    });

    document.getElementById('attendanceForm').addEventListener('submit', function (e) {
      const lat = document.getElementById("latitude").value;
      const lon = document.getElementById("longitude").value;

      if (!lat || !lon) {
        e.preventDefault();
        alert("Location access is required to submit attendance.");
      } else {
        const dist = haversine(parseFloat(lat), parseFloat(lon), allowedLat, allowedLon);
        if (dist > allowedRadius) {
          e.preventDefault();
          alert(`You are outside the allowed area (${dist.toFixed(1)} meters). Attendance cannot be marked.`);
        }
      }
    });
  </script>
</body>
</html>
